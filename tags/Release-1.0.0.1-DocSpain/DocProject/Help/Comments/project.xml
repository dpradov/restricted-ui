<?xml version="1.0" encoding="utf-8"?>
<doc>
  <members>
    <member name="R:Project">
      <remarks>
        <span lang="ES-MODERN">
          <p>
            <strong>Licencia</strong>
          </p>
          <span lang="ES-MODERN">
            <p>RestrictedUI: MOZILLA PUBLIC LICENSE STATEMENT.<br />----------------------------------------------------------<br /> The contents of this file are subject to the Mozilla Public<br /> License Version 1.1 (the "License"); you may not use this file<br /> except in compliance with the License. You may obtain a copy of<br /> the License at <a href="http://www.mozilla.org/MPL/">http://www.mozilla.org/MPL/</a></p>
            <p> Software distributed under the License is distributed on an "AS<br /> IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or<br /> implied. See the License for the specific language governing<br /> rights and limitations under the License.</p>
            <p> The Original Code is RestrictedUI 1.0.</p>
            <p> The Initial Developer of the Original Code is Daniel Prado Velasco<br /> &lt;<a href="mailto:dpradov@gmail.com">dpradov@gmail.com</a>&gt; (Spain).<br /> Portions created by Daniel Prado Velasco are<br /> Copyright (C) 2010. All Rights Reserved.<br /> -----------------------------------------------------------<br /> Contributor(s):<br /> -----------------------------------------------------------<br /> History:<br /> -----------------------------------------------------------<br /> Released: 04 April 2010<br /> -----------------------------------------------------------<br /> URLs:<br />  <a href="http://code.google.com/p/restricted-ui/">http://code.google.com/p/restricted-ui/</a><br /></p>
          </span>
        </span>
      </remarks>
      <summary>
        <div class="issueDetail">
          <div style="MARGIN: 0px 0px -3px" align="left">
            <img border="0" hspace="0" alt="" align="baseline" src="file:///D:/PROYECTOS/Restricted-ui/DocProject/Help/Art/IconRestrictedUI.gif" /> <a style="COLOR: rgb(0,0,0); TEXT-DECORATION: none" href="http://code.google.com/p/restricted-ui/">restricted-ui</a>: <i><a style="COLOR: rgb(0,0,0); TEXT-DECORATION: none" id="project_summary_link" href="http://code.google.com/p/restricted-ui/">.NET Library to restrict user interface based on security policy</a></i></div>
          <div> </div>
          <div> </div>
        </div>
        <div class="issueDetail">
          <strong>Namespaces </strong>
        </div>
        <see cref="N:RestrictedUI">RestrictedUI</see>  <see cref="N:RestrictedWebUI">RestrictedWebUI</see>  <see cref="N:RestrictedWinFormsUI">RestrictedWinFormsUI</see>  <see cref="N:RestrictedWinFormsUI_Infragistics">RestrictedWinFormsUI_Infragistics</see>  
<div style="FONT-STYLE: italic; MARGIN-TOP: 3px"> </div><div style="FONT-STYLE: italic; MARGIN-TOP: 3px"> </div><div style="FONT-STYLE: italic; MARGIN-TOP: 3px"><strong>Tutorial</strong></div><p><ul><li>1. Introducción 
<ul><li>Características principales</li></ul><li>2. Usando el código 
<ul><li>2.1. Entidades principales 
<ul><li>ControlRestrictedUI 
<li>ControlRestrictedUIWeb 
<li>ControlRestrictedUIWinForms 
<li>IControlAdapter 
<li>IControlAdapterFactory 
<li>UIRestrictions 
<li>RestrictionOnControl 
<li>IHost 
<li>SecurityEnvironment</li></li></li></li></li></li></li></li></li></ul><li>2.2. Ejemplo de uso 
<ul><li>Mantenimiento de la política de seguridad: FrmRestrictionsUIDefinition</li></ul><li>2.3. Proyectos de test</li></li></li></ul><li>3. Points of Interest </li></li></li></ul><p> </p><p> </p><h1><a name="1._Introducción">1. Introducción</a></h1><p><a name="1._Introducción">Una parte delicada de la implementación de la seguridad en aplicaciones, especialmente corporativas, consiste en determinar qué funcionalidad debe estar o no accesible al usuario en función de su rol, o qué elementos deben o no mostrarse. </a></p><p><a name="1._Introducción">Lo habitual es incluir en el código la lógica necesaria para ocultar o deshabilitar determinadas opciones, botones, etc, dependiendo del tipo de usuario que accede a la aplicación. Esto puede complicarse cuando aparte del tipo de usuario también debe tenerse en cuenta el estado en que se encuentra la aplicación, por ejemplo el estado de tramitación de una entidad. Es bastante usual que esta política deba cambiar con cierta frecuencia, de la misma forma que deben evolucionar los requerimientos de las aplicaciones. Modificaciones en la estructura organizativa de la empresa, cambios en los protocolos de gestión de las unidades implicadas o simplemente la identificación de carencias tras el uso de la aplicación, entre otras causas, llevan a tener que hacer adaptaciones a esta lógica ligada a la interface. </a></p><p><a name="1._Introducción">En respuesta a esta problemática cabe también la opción de centralizar la definición de esta política, en un repositorio común a múltiples aplicaciones. En base a esta definición, soportada por un modelo de datos determinado, es posible definir una librería que utilicen las aplicaciones, y que haga posible modificar la política de seguridad sin necesidad de recompilar y redistribuir las aplicaciones. La idea principal es la siguiente: el programador desarrolla como si sólo hubiera un tipo de usuario, el administrador, con permisos para hacer cualquier cosa. Es la librería la que controla si debe impedirse un intento de hacer visible o de habilitar determinados controles. </a></p><p><a name="1._Introducción">Este enfoque es el que se usa actualmente en la empresa en la que trabajo. Aun ofreciendo gran flexibilidad en su concepción, la implementación concreta de la misma presenta desde mi punto de vista una serie de limitaciones y dificultades concretas que he intentado corregir con esta otra librería/arquitectura: </a></p><p><a name="1._Introducción" /> </p><h2><a name="Características_principales">Características principales</a></h2><p><a name="Características_principales">Por un lado la librería / arquitectura que aquí se explica no obliga a centralizar la definición de esta seguridad, pero sí la contempla como un caso más; por otro lado para asegurar el cumplimiento de estas restricciones no es necesario obligar al programador a utilizar métodos ni propiedades específicas de la librería, que verifiquen si el cambio se permite o no, ni tiene que ser controlado por código a añadir; simplemente cualquier intento de hacer visible o habilitar cualquier elemento de interface supervisado que no sea admitido por la política de seguridad es interceptado e impedido. Se permite definir la política de restricciones no sólo en base a roles sino a estados de la aplicación, tanto en aplicaciones WinForms como Web; y para simplificar la definición de esta política se ofrece un formulario de mantenimiento, disponible tanto en tiempo de diseño como de ejecución. </a></p><p><a name="Características_principales">Notas: </a></p><ul><li><a name="Características_principales">No es objetivo de esta librería controlar la autenticación del usuario. Se asume que ésta es realizada correctamente y que se conoce, con garantías, el rol o roles que ostenta el usuario. </a><li><a name="Características_principales">El nombre de la librería, RestrictedUI, hace referencia al hecho de que ciertos elementos de la interface estarán restringidos según la seguridad establecida ('área restringida') </a></li></li></ul><p><a name="Características_principales"><br /><br /></a></p><h1><a name="2._Usando_el_código">2. Usando el código</a></h1><p><a name="2._Usando_el_código">Paso a describir a continuación con más detalle esta librería: </a></p><h2><a name="2.1._Entidades_principales">2.1. Entidades principales</a></h2><p><a name="2.1._Entidades_principales"><br /><img src="file:///D:/PROYECTOS/Restricted-ui/DocProject/Help/Art/modelo1.gif" /></a></p><p><a name="2.1._Entidades_principales"><br /><br /></a></p><p><a name="2.1._Entidades_principales"><img src="file:///D:/PROYECTOS/Restricted-ui/DocProject/Help/Art/modelo2.gif" /></a></p><p><a name="2.1._Entidades_principales"><br />Las clases principales y con las que se interactuará serán fundamentalmente: <tt>ControlRestrictedUI</tt> (a través de alguna de los componentes concretos que se ofrecen, bien para WinForms bien para Web), <tt>SecurityEnvironment</tt> e <tt>IHost</tt>. La primera contiene la mayor parte de la lógica de negocio, y es la responsable de asegurar la seguridad UI en el control en el que se encuentra, apoyándose en otras clases. La segunda, <tt>SecurityEnvironment</tt>, es un objeto Singleton que permite configurar aspectos comunes a todos los componentes y sobre todo hace posible el establecimiento masivo de la seguridad, para todos o parte de los componentes (necesario para la carga de las restricciones desde un repositorio centralizado). La tercera, <tt>IHost</tt>, es la interface que debe ofrecer la aplicación que haga uso de esta librería y que permitirá saber el estado de la aplicación y el rol o roles del usuario. La política de restricciones que se aplican en un componente <tt>ControlRestrictedUI</tt> se almacenan bajo la forma de un objeto <tt>UIRestrictions</tt> y éste a su vez contiene una lista de restricciones (permisos y prohibiciones), que no son más que estructuras <tt>RestrictionOnControl</tt>. Más abajo se describen con un poco más de detalle estas dos entidades y con ellas cómo se define la política de seguridad. En el caso de que se necesite trabajar con controles que no estén ya contemplados o se necesite gestionar alguno de ellos de una manera diferente, se habrán de crear los adaptadores correspondientes (<tt>IControlAdapter</tt>) y también la factoría que los genere (<tt>IControlAdapterFactory</tt>). Lo único que habrá que hacer en estos casos es preparar un nueva librería que incluya los nuevos adaptadores necesarios así como la factoría correspondiente. Este factoría se añadiría al objeto <tt>SecurityEnvironment</tt> como se explica en el ejemplo que se describe más adelante. Para crear estos adaptadores y factorías puede basarse en los ya disponibles. </a></p><p><a name="2.1._Entidades_principales">Las clases y métodos más destacables son: </a></p><p><a name="2.1._Entidades_principales"><br /></a></p><h3><a name="ControlRestrictedUI"><tt>ControlRestrictedUI</tt></a></h3><p><a name="ControlRestrictedUI">Componente base de la librería de Interface Restringida (!RestrictedUI): permite restringir la visibilidad y estado de habilitación de los controles incluidos en un formulario o control de usuario en base a una definición de seguridad establecida, en la que intervienen el estado actual de la aplicación en dicho formulario o contenedor así como el rol o roles que tenga el usuario de la aplicación. </a></p><ul><li><a name="ControlRestrictedUI"><tt><strong>ChangeAllowed</strong></tt> Es el método que evalúa la política de restricciones y decide si permite o no un determinado cambio sobre un control. Comprueba si el cambio sobre la propiedad Visible o Enabled (o la correspondiente del control) es válido atendiendo a la definición de seguridad, a los roles del usuario y al estado actual de la aplicación. </a></li></ul><ul><li><a name="ControlRestrictedUI"><tt><strong>VerifyChange</strong></tt> - Comprueba si el cambio sobre la propiedad indicada (<tt>TChange</tt>) es válido atendiendo a la definición de seguridad, a los roles del usuario y al estado actual de la aplicación. Si el cambio no es válido se deshará, esto es, se establecerá nuevamente a False </a></li></ul><blockquote><a name="ControlRestrictedUI">Los adaptadores de control llaman a este método del componente de seguridad en respuesta al intento de modificación de las propiedades supervisadas. </a></blockquote><ul><li><a name="ControlRestrictedUI"><tt><strong>RegisterControls</strong></tt> - Fuerza el registro o actualización de los controles existentes en el formulario o contenedor en donde está incrustado este componente <tt>ControlRestrictedUI</tt>. </a></li></ul><ul><li><a name="ControlRestrictedUI"><tt><strong>ID, InstanceID</strong></tt> - Identificador del componente y de la instancia concreta. A partir del <tt>ID</tt> podrá leerse/actualizarse la seguridad desde un archivo, para establecerla a nivel de entorno. Con estos dos atributos el objeto <tt>IHost</tt> podrá indicar el estado y roles que aplican, distinguiendo no sólo por pantalla sino por instancia concreta. </a></li></ul><ul><li><a name="ControlRestrictedUI"><tt><strong>RestrictionsDefinition</strong></tt> - Configuración de los bloqueos y permisos que se establecerán. </a></li></ul><ul><li><a name="ControlRestrictedUI"><tt><strong>BeforeApplyingRestriction</strong></tt> - Ocurre justo antes de llegar a permitir o impedir el cambio de la propiedad <tt>Visible</tt> o <tt>Enabled</tt>, para dar la opción de permitir o no el cambio en base a una lógica más compleja </a></li></ul><ul><li><a name="ControlRestrictedUI"><tt><strong>ConfigFile</strong></tt> - Obtiene o establece la ruta hacia un fichero de configuración, a utilizar fundamentalmente en tiempo de diseño. </a></li></ul><blockquote><a name="ControlRestrictedUI">El fichero de configuración hace posible ofrecer en tiempo de diseño y durante la definición de la seguridad en el formulario <tt>FrmRestrictionsUIDefinition</tt> la relación de roles y estados a utilizar, así como de factorías de adaptadores adicionales, para así 'descubrir' nuevos controles en tiempo de diseño. Las propias definiciones de restricciones de seguridad, de todos o sólo algunos componentes pueden estar contenidas en este archivo. Estas restricciones pueden cargarse en tiempo de ejecución mediante el método <tt>LoadFrom()</tt> así como cargarse y grabarse a voluntad desde el formulario <tt>FrmRestrictionsUIDefinition</tt>, en tiempo de diseño o de ejecución. </a></blockquote><ul><li><a name="ControlRestrictedUI"><tt><strong>ControlsFile</strong></tt> - Nombre del archivo sobre el que podrá escribirse la relación los controles contenidos en el formulario o control de usuario controlado por este componente. </a></li></ul><blockquote><a name="ControlRestrictedUI">Este archivo hace posible ofrecer en tiempo de diseño desde el formulario <tt>FrmRestrictionsUIDefinition</tt> controles que se crearán dinámicamente. Para aplicaciones Web debe utilizarse necesariamente para poder configurar la seguridad en tiempo de diseño con la ayuda de ese formulario. </a></blockquote><p><a name="ControlRestrictedUI"><br /></a></p><h3><a name="ControlRestrictedUIWeb"><tt>ControlRestrictedUIWeb</tt></a></h3><p><a name="ControlRestrictedUIWeb">Adaptación, para aplicaciones Web, del componente <tt>ControlRestrictedUI</tt>. </a></p><p><a name="ControlRestrictedUIWeb"><br /></a></p><h3><a name="ControlRestrictedUIWinForms"><tt>ControlRestrictedUIWinForms</tt></a></h3><p><a name="ControlRestrictedUIWinForms">Adaptación, para aplicaciones WinForms, del componente <tt>ControlRestrictedUI</tt>. </a></p><p><a name="ControlRestrictedUIWinForms"><br /></a></p><h3><a name="IControlAdapter"><tt>IControlAdapter</tt></a></h3><p><a name="IControlAdapter">Envuelve un 'control' con el objetivo de ofrecer de manera homogénea el acceso a sus propiedades <tt>Enabled</tt> y <tt>Visible</tt>, así como a sus 'controles' hijo, permitiendo además ofrecer la supervisión del cambio de esas propiedades, dando así opción a impedir dichos cambios en base a un esquema de seguridad. Lo que el adaptador envuelva no tiene necesariamente que ser un objeto de una clase determinada puede ser cualquier elemento que el adaptador 'entienda', sobre el cual se pueda e interese controlar su visibilidad y/o si está o no habilitado, y que un adaptador 'padre' haya reconocido como hijo. Las propiedades realmente controladas no tienen por qué ser exactamente <tt>Visible</tt> y <tt>Enabled</tt>; es responsabilidad del adaptador de control ofrecer esa interface y actuar sobre las propiedades que tenga el control (por ejemplo, algunos controles no ofrecen <tt>Enabled</tt> pero sí <tt>ReadOnly</tt>) Los controles que ofrece el formulario de mantenimiento de la seguridad (<tt>FrmRestrictionsUIDefinition</tt>) así como los controles donde busca el componente <tt>ControlRestrictedUI</tt> son todos aquellos ofrecidos como 'hijos' por el control en donde esté incrustado el componente. El adaptador de este control padre irá preguntando a los adaptadores de sus controles hijo, lo que irá haciendo descubrir nuevos controles. Así, si se cuenta con un adaptador que entienda de controles DataGridView, por ejemplo, es posible ofrecer cada una de las columnas como un hijo a supervisar. De esta manera, el número de controles a supervisar dependerá de los adaptadores con los que se trabaje, y esto dependerá a su vez de las factorías que se hayan podido incorporar: </a></p><p><a name="IControlAdapter"><br /></a></p><h3><a name="IControlAdapterFactory"><tt>IControlAdapterFactory</tt></a></h3><p><a name="IControlAdapterFactory">Define una factoría externa de adaptadores de control. Éstas serán consultadas antes que la factoría base (interna) a la hora de localizar el adaptador a utilizar. Sólo define el siguiente método GetAdapter</a><a href="http://code.google.com/p/restricted-ui/w/edit/GetAdapter">?</a> Devuelve el adaptador más idóneo correspondiente al control que se le pasa, según la factoría. Si la factoría no tiene ningún adaptador adecuado para ese control devolverá el adaptador especial <tt>NullControlAdapter</tt></p><p><br /></p><h3><a name="UIRestrictions"><tt>UIRestrictions</tt></a></h3><p><a name="UIRestrictions">Contiene todas las restricciones de interface (UI) (permisos y prohibiciones) que definen la seguridad para un componente <tt>ControlRestrictedUI</tt>, y que afectan normalmente por tanto a un formulario o control de usuario. Todas las restricciones se aplican a nivel de controles individuales, teniendo presente que las prohibiciones tendrán prioridad sobre los permisos, esto es, primero se aplicarán los permisos y luego se restringirán en base a las prohibiciones: Prohibiciones: sólo se impedirán las modificaciones de las propiedades <tt>Visible</tt> / <tt>Enabled</tt> en las situaciones aquí señaladas. Permisos: sólo se autorizarán las modificaciones de las propiedades <tt>Visible</tt> / <tt>Enabled</tt> en las situaciones aquí señaladas Esta clase guarda restricciones individuales (ver <tt>RestrictionOnControl</tt>) y detemina si se deben considerar en lógica positiva (permisos) o negativa (prohibiciones). Es la encargada de serializar y deserializar estos permisos. </a></p><p><a name="UIRestrictions"><br /></a></p><h3><a name="RestrictionOnControl"><tt>RestrictionOnControl</tt></a></h3><p><a name="RestrictionOnControl">Define los elementos que configuran una restricción concreta a supervisar. Esta restricción sólo tendrá pleno sentido interpretada conjuntamente con el resto de restricciones incluidas en una definición de seguridad definida en un objeto <tt>UIRestrictions</tt> y gestionada por un componente <tt>ControlRestrictedUI</tt>. <br />Los elementos que configuran una restricción individual son: Control a supervisar (a través de un adaptador) Propiedades a controlar (<tt>Visible</tt> y/o <tt>Enabled</tt>) Contexto de la aplicación para el que se define la restricción: Estos elementos podrán ser aplicados en lógica positiva (permisos) o negativa (prohibiciones). Esta interpretación no la ofrece esta estructura sino la clase <tt>UIRestrictions</tt> dependiendo de que esta restricción haya sido incluida en una línea de permisos o prohibiciones. </a></p><ul><li><a name="RestrictionOnControl">Si la restricción consiste en un permiso indicará que las propiedades supervisadas del control sólo las podrán 'activar' (hacer visible o habilitar) los roles indicados y únicamente cuando la aplicación esté en los estados señalados. </a><li><a name="RestrictionOnControl">Si la restricción consiste en una prohibición indicará que las propiedades supervisadas del control no podrán ser 'activadas' por los roles indicados cuando la aplicación esté en los estados señalados. Para cualquier combinación de roles/estado distinta sí será posible la activación. </a><li><a name="RestrictionOnControl">Si no se aporta ningún rol (por defecto se asume rol = 0) entonces aplicará a todos los roles: a todos se les permitirá o impedirá (según) en los estados señalados </a><li><a name="RestrictionOnControl">Si no se aporta ningún estado entonces la restricción aplicará a los roles que correspondan con independencia del estado en que esté la aplicación. </a><li><a name="RestrictionOnControl">Si un control no tiene ningún elemento de restricción asociado (ni positivo ni negativo) entonces no será supervisado, y cualquier rol y en cualquier estado podrá activar sus propiedades <tt>Visible</tt> y <tt>Enabled</tt>. </a></li></li></li></li></li></ul><a name="RestrictionOnControl">Las propiedades realmente controladas en el control no tienen por qué ser exactamente '<tt>Visible</tt>' y '<tt>Enabled</tt>' (como se indica en <tt>IControlAdapter</tt>) Sólo se supervisa y tal vez se impida (según la política definida) la 'activación' de esas propiedades, esto es, el intento de hacer visible o habilitar el control. No se impide el hacer invisible o deshabilitar un control. </a><p><a name="RestrictionOnControl"><br /></a></p><h3><a name="IHost"><tt>IHost</tt></a></h3><p><a name="IHost">Indica que el objeto puede actuar como intermediario en la comunicación necesaria entre la aplicación Host y la librería de Interface Restringida permitiendo a ésta consultar en cualquier momento el estado de la aplicación y el rol o roles que pueda tener el usuario de la misma. Informa también mediante eventos de cambios en estos valores. Estos datos (estado y roles) podrán ser dependientes del formulario o control de usuario desde el que se pregunte (tipo e instancia concreta). Este enfoque permite, por ejemplo, mantener abiertas diferentes instancias de una determinada ventana, cada una de ellas en un estado o fase de tramitación diferente y por tanto con requerimientos de seguridad distintos. Aunque es más común que el rol o roles del usuario sean uniformes por toda la aplicación se permite que puedan también depender de donde se ubique el componente de seguridad y de la instancia concreta. De esta manera se da más margen de maniobra a la hora de configurar la seguridad. </a></p><p><a name="IHost"><br /></a></p><h3><a name="SecurityEnvironment"><tt>SecurityEnvironment</tt></a></h3><p><a name="SecurityEnvironment">Clase Singleton (vía Shared) que mantiene aspectos generales a todo el esquema de seguridad. </a></p><ul><li><a name="SecurityEnvironment"><tt><strong>CommonStates, CommonRoles</strong></tt> - Permiten establecer los estados y roles comunes, que se ofrecen en todos los componentes de seguridad </a></li></ul><ul><li><a name="SecurityEnvironment"><tt><strong>ComponentsSecurity</strong></tt> - Devuelve el objeto diccionario en el que se guarda la definición de seguridad (política de restricciones de interface) de los diferentes componentes, según pueda haberse establecido a partir de la carga de un fichero de configuración o de una cadena de texto. </a></li></ul><blockquote><a name="SecurityEnvironment">La seguridad aquí contenida no tiene por qué ser igual a la embebida en los distintos componentes. La que aplique finalmente en el componente depende de una propiedad del mismo (<tt>ProrityEmbeddedSecurity</tt>) Métodos como <tt>LoadFrom</tt> o <tt>LoadFromString</tt>, por ejemplo, forzarán la prioridad a la seguridad del entorno sobre la embebida, para un componente, cuando en el fichero o cadena (p.ej) aparezca referenciado ese componente, aunque sea con un definición vacía. </a></blockquote><ul><li><a name="SecurityEnvironment"><tt><strong>BaseFactory, AditionalFactories</strong></tt> - Obtiene o establece la factoría de adaptadores que se considera base, así como otras adicionales. A la hora de buscar el mejor adaptador para un control se comenzará buscando en las adicionales y si no se encuentra ninguno, finalmente en factoria base. </a></li></ul><ul><li><a name="SecurityEnvironment"><tt><strong>Host</strong></tt> - Recupera o establece el objeto que implementa la interface <tt>IHost</tt> y a través de la cual el entorno y el resto de componentes de seguridad puede interaccionar con la aplicación Host a efectos de conocer el estado y roles actuales que deben considerarse </a></li></ul><ul><li><a name="SecurityEnvironment"><tt><strong>AddFactory</strong></tt> - Agrega la factoría de adaptadores de control indicada. Será consultada antes que la factoría interna </a></li></ul><ul><li><a name="SecurityEnvironment"><tt><strong>GetAdapter</strong></tt> - Devuelve el adaptador (<tt>IControlAdapter</tt>) correspondiente al control indicado, en base a las factorías registradas en el Entorno. </a></li></ul><ul><li><a name="SecurityEnvironment"><tt><strong>LoadFrom, LoadFromString</strong></tt> - Permiten cargar la política de seguridad, a nivel de entorno, a partir de un fichero, un stream o una cadena de texto. </a></li></ul><p><a name="SecurityEnvironment"><br /><br /></a></p><h2><a name="2.2._Ejemplo_de_uso">2.2. Ejemplo de uso</a></h2><p><a name="2.2._Ejemplo_de_uso">Es necesario hacer referencia a la DLL RestrictedUI.dll así como RestrictedWinFormsUI.dll o RestrictedWebUI.dll, según la aplicación. Si incluimos en la aplicación algún tipo de control especial que queramos tratar de manera personalizada entonces añadiremos también una referencia a la DLL correspondiente, que tendrá implementada una factoría de adaptadores para ese control especial. En el siguiente ejemplo se hace uso de una librería que interpreta los controles UltraGrid y UltraTree de Infragistics (</a><a href="http://www.infragistics.com/dotnet/netadvantage.aspx" rel="nofollow">NetAdventage</a>). </p><p>Al arranque de la aplicación hacemos la siguiente inicialización, donde la única línea realmente importante es la primera: <br /></p><pre class="prettyprint"><span class="str">' Configuración inicial de la librería de seguridad:'</span><span class="pln"><br /></span><span class="str">'-----------------------------------------'</span><span class="pln"><br /><br /></span><span class="str">' Establecer el objeto IHost que permitirá conocer el estado y roles de la aplicación'</span><span class="pln"><br /> </span><span class="typ">SecurityEnvironment</span><span class="pun">.</span><span class="typ">Host</span><span class="pln"></span><span class="pun">=</span><span class="pln"> _host<br /><br /></span><span class="str">' No queremos que se actualicen los ficheros de controles automáticamente al inicializarse los'</span><span class="pln"><br /></span><span class="str">' componentes de seguridad. Lo actualizaremos cuando tengamos todos los controles creados (algunos'</span><span class="pln"><br /></span><span class="str">' los construiremos dinámicamente: columnas de un datagrid)'</span><span class="pln"><br /> </span><span class="typ">SecurityEnvironment</span><span class="pun">.</span><span class="typ">AutomaticUpdateOfControlsFile</span><span class="pln"></span><span class="pun">=</span><span class="pln"></span><span class="kwd">False</span><span class="pln"><br /><br /></span><span class="str">' Como incluimos controles Infragistics y éstos no se contemplan en la factoría interna que viene'</span><span class="pln"><br /></span><span class="str">' junto a la librería SeguridadWinForms.dll registraremos la factoría que sí los gestiona'</span><span class="pln"><br /> </span><span class="typ">SecurityEnvironment</span><span class="pun">.</span><span class="typ">AddFactory</span><span class="pun">(</span><span class="typ">AdapterInfragisticsWinForms_Factory</span><span class="pun">.</span><span class="pln">getInstance</span><span class="pun">)</span><span class="pln"><br /><br /></span><span class="str">' Algunos adaptadores, como éste, pueden permitir controlar el estado de habilitado o no con la propiedad ReadOnly'</span><span class="pln"><br /></span><span class="str">' en lugar de Enabled (esta última sería la por defecto)'</span><span class="pln"><br /> </span><span class="typ">AdapterWinForms_DataGridView</span><span class="pun">.</span><span class="typ">UseReadOnly</span><span class="pln"></span><span class="pun">=</span><span class="pln"></span><span class="kwd">True</span><span class="pln"><br /> </span><span class="typ">AdapterInfragisticsWinForms_UltraGrid</span><span class="pun">.</span><span class="typ">UseReadOnly</span><span class="pln"></span><span class="pun">=</span><span class="pln"></span><span class="kwd">True</span><span class="pln"><br /><br /></span><span class="str">' Al margen de que tengamos definida alguna seguridad de manera embebida en algún componente, '</span><span class="pln"><br /></span><span class="str">' utilizaremos la definida en un archivo. (También podríamos haber leído la seguridad desde un'</span><span class="pln"><br /></span><span class="str">' Stream facilitando un System.IO.StreamReader, o directamente desde una cadena con EntornoSeguridad.LoadFromString'</span><span class="pln"><br /> </span><span class="typ">SecurityEnvironment</span><span class="pun">.</span><span class="typ">LoadFrom</span><span class="pun">(</span><span class="str">"TestWinForms\Security.txt"</span><span class="pun">)</span></pre><blockquote>(Más adelante se muestra un ejemplo de fichero de configuración que puede ser cargado mediante <tt>LoadFrom</tt>) </blockquote><p><br />El objeto <i>host sería de la clase Host, que implementaría la interface <tt>IHost</tt>, por ejemplo de esta forma (TestForm): </i></p><pre class="prettyprint"><span class="typ">Public</span><span class="pln"></span><span class="typ">Class</span><span class="pln"></span><span class="typ">Host</span><span class="pln"><br />    </span><span class="typ">Implements</span><span class="pln"></span><span class="typ">IHost</span><span class="pln"><br /><br />    </span><span class="typ">Public</span><span class="pln"></span><span class="typ">Event</span><span class="pln"></span><span class="typ">StateChanged</span><span class="pun">(</span><span class="typ">ByVal</span><span class="pln"> ID </span><span class="typ">As</span><span class="pln"></span><span class="typ">String</span><span class="pun">,</span><span class="pln"></span><span class="typ">ByVal</span><span class="pln"> instanceID </span><span class="typ">As</span><span class="pln"></span><span class="typ">String</span><span class="pun">,</span><span class="pln"></span><span class="typ">ByVal</span><span class="pln"> newState </span><span class="typ">As</span><span class="pln"></span><span class="typ">Integer</span><span class="pun">)</span><span class="pln"></span><span class="typ">Implements</span><span class="pln"></span><span class="typ">RestrictedUI</span><span class="pun">.</span><span class="typ">IHost</span><span class="pun">.</span><span class="typ">StateChanged</span><span class="pln"><br />    </span><span class="typ">Public</span><span class="pln"></span><span class="typ">Event</span><span class="pln"></span><span class="typ">RolesChanged</span><span class="pun">(</span><span class="typ">ByVal</span><span class="pln"> ID </span><span class="typ">As</span><span class="pln"></span><span class="typ">String</span><span class="pun">,</span><span class="pln"></span><span class="typ">ByVal</span><span class="pln"> instanceID </span><span class="typ">As</span><span class="pln"></span><span class="typ">String</span><span class="pun">)</span><span class="pln"></span><span class="typ">Implements</span><span class="pln"></span><span class="typ">RestrictedUI</span><span class="pun">.</span><span class="typ">IHost</span><span class="pun">.</span><span class="typ">RolesChanged</span><span class="pln"><br /><br />    </span><span class="typ">Public</span><span class="pln"></span><span class="typ">Sub</span><span class="pln"></span><span class="typ">ShowError</span><span class="pun">(</span><span class="typ">ByVal</span><span class="pln"></span><span class="pun">[</span><span class="pln">error</span><span class="pun">]</span><span class="pln"></span><span class="typ">As</span><span class="pln"></span><span class="typ">String</span><span class="pun">)</span><span class="pln"></span><span class="typ">Implements</span><span class="pln"></span><span class="typ">IHost</span><span class="pun">.</span><span class="typ">ShowError</span><span class="pln"><br />        </span><span class="str">' Hay controles que se crean dinámicamente y es normal que no se localicen en el evento HandleCreated (caso de WinForms)'</span><span class="pln"><br />        </span><span class="typ">If</span><span class="pln"></span><span class="pun">[</span><span class="pln">error</span><span class="pun">].</span><span class="typ">Contains</span><span class="pun">(</span><span class="str">"Control no localizado"</span><span class="pun">)</span><span class="pln"></span><span class="typ">Then</span><span class="pln"><br />            </span><span class="typ">If</span><span class="pln"></span><span class="pun">[</span><span class="pln">error</span><span class="pun">].</span><span class="typ">Contains</span><span class="pun">(</span><span class="str">"cControles."</span><span class="pun">)</span><span class="pln"></span><span class="typ">Then</span><span class="pln"><br />                </span><span class="typ">Exit</span><span class="pln"></span><span class="typ">Sub</span><span class="pln"><br />            </span><span class="typ">End</span><span class="pln"></span><span class="typ">If</span><span class="pln"><br />        </span><span class="typ">End</span><span class="pln"></span><span class="typ">If</span><span class="pln"><br /><br />        </span><span class="typ">MessageBox</span><span class="pun">.</span><span class="typ">Show</span><span class="pun">([</span><span class="pln">error</span><span class="pun">])</span><span class="pln"><br />    </span><span class="typ">End</span><span class="pln"></span><span class="typ">Sub</span><span class="pln"><br /><br />    </span><span class="str">' En esta implementación, el estado podrá ser diferente según el control e instancia que pregunte'</span><span class="pln"><br />    </span><span class="typ">Public</span><span class="pln"></span><span class="typ">Property</span><span class="pln"></span><span class="typ">State</span><span class="pun">(</span><span class="typ">ByVal</span><span class="pln"> ID </span><span class="typ">As</span><span class="pln"></span><span class="typ">String</span><span class="pun">,</span><span class="pln"></span><span class="typ">ByVal</span><span class="pln"> instanceID </span><span class="typ">As</span><span class="pln"></span><span class="typ">String</span><span class="pun">)</span><span class="pln"></span><span class="typ">As</span><span class="pln"></span><span class="typ">Integer</span><span class="pln"></span><span class="typ">Implements</span><span class="pln"></span><span class="typ">RestrictedUI</span><span class="pun">.</span><span class="typ">IHost</span><span class="pun">.</span><span class="typ">State</span><span class="pln"><br />        </span><span class="typ">Get</span><span class="pln"><br />            </span><span class="typ">Dim</span><span class="pln"> nState </span><span class="typ">As</span><span class="pln"></span><span class="typ">Integer</span><span class="pln"></span><span class="pun">=</span><span class="pln"></span><span class="lit">0</span><span class="pln"><br />            _State</span><span class="pun">.</span><span class="typ">TryGetValue</span><span class="pun">(</span><span class="pln">ID </span><span class="pun">+</span><span class="pln"> instanceID</span><span class="pun">,</span><span class="pln"> nState</span><span class="pun">)</span><span class="pln"><br />            </span><span class="typ">Return</span><span class="pln"> nState<br />        </span><span class="typ">End</span><span class="pln"></span><span class="typ">Get</span><span class="pln"><br />        </span><span class="typ">Set</span><span class="pun">(</span><span class="typ">ByVal</span><span class="pln"> value </span><span class="typ">As</span><span class="pln"></span><span class="typ">Integer</span><span class="pun">)</span><span class="pln"><br />            _State</span><span class="pun">.</span><span class="typ">Remove</span><span class="pun">(</span><span class="pln">ID </span><span class="pun">+</span><span class="pln"> instanceID</span><span class="pun">)</span><span class="pln"><br />            _State</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="pln">ID </span><span class="pun">+</span><span class="pln"> instanceID</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">)</span><span class="pln"><br />            </span><span class="typ">RaiseEvent</span><span class="pln"></span><span class="typ">StateChanged</span><span class="pun">(</span><span class="pln">ID</span><span class="pun">,</span><span class="pln"> instanceID</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">)</span><span class="pln"><br />        </span><span class="typ">End</span><span class="pln"></span><span class="typ">Set</span><span class="pln"><br />    </span><span class="typ">End</span><span class="pln"></span><span class="typ">Property</span><span class="pln"><br />    </span><span class="typ">Private</span><span class="pln"> _State </span><span class="typ">As</span><span class="pln"></span><span class="typ">New</span><span class="pln"></span><span class="typ">Dictionary</span><span class="pun">(</span><span class="typ">Of</span><span class="pln"></span><span class="typ">String</span><span class="pun">,</span><span class="pln"></span><span class="typ">Integer</span><span class="pun">)</span><span class="pln"><br /><br />    </span><span class="str">' En esta implementación, los roles que devolvamos serán los mismos con independencia del formulario o de la instancia'</span><span class="pln"><br />    </span><span class="typ">Public</span><span class="pln"></span><span class="typ">Property</span><span class="pln"></span><span class="typ">UserRoles</span><span class="pun">(</span><span class="typ">ByVal</span><span class="pln"> ID </span><span class="typ">As</span><span class="pln"></span><span class="typ">String</span><span class="pun">,</span><span class="pln"></span><span class="typ">ByVal</span><span class="pln"> instanceID </span><span class="typ">As</span><span class="pln"></span><span class="typ">String</span><span class="pun">)</span><span class="pln"></span><span class="typ">As</span><span class="pln"></span><span class="typ">Integer</span><span class="pun">()</span><span class="pln"></span><span class="typ">Implements</span><span class="pln"></span><span class="typ">RestrictedUI</span><span class="pun">.</span><span class="typ">IHost</span><span class="pun">.</span><span class="typ">UserRoles</span><span class="pln"><br />        </span><span class="typ">Get</span><span class="pln"><br />            </span><span class="typ">Return</span><span class="pln"> _userRoles<br />        </span><span class="typ">End</span><span class="pln"></span><span class="typ">Get</span><span class="pln"><br />        </span><span class="typ">Set</span><span class="pun">(</span><span class="typ">ByVal</span><span class="pln"> value </span><span class="typ">As</span><span class="pln"></span><span class="typ">Integer</span><span class="pun">())</span><span class="pln"><br />            _userRoles </span><span class="pun">=</span><span class="pln"> value<br />            </span><span class="typ">RaiseEvent</span><span class="pln"></span><span class="typ">RolesChanged</span><span class="pun">(</span><span class="pln">ID</span><span class="pun">,</span><span class="pln"> instanceID</span><span class="pun">)</span><span class="pln"><br />        </span><span class="typ">End</span><span class="pln"></span><span class="typ">Set</span><span class="pln"><br />    </span><span class="typ">End</span><span class="pln"></span><span class="typ">Property</span><span class="pln"><br />    </span><span class="typ">Private</span><span class="pln"> _userRoles </span><span class="typ">As</span><span class="pln"></span><span class="typ">Integer</span><span class="pun">()</span><span class="pln"></span><span class="pun">=</span><span class="pln"></span><span class="typ">New</span><span class="pln"></span><span class="typ">Integer</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span><span class="pln"></span><span class="pun">{</span><span class="lit">10</span><span class="pun">,</span><span class="pln"></span><span class="lit">11</span><span class="pun">}</span><span class="pln"><br /><br /></span><span class="typ">End</span><span class="pln"></span><span class="typ">Class</span></pre><p>Aunque en la interface <tt>IHost</tt> las propiedades <tt>State</tt> y <tt>UserRoles</tt> no se han establecido como ReadOnly la lectura de estas propiedades es lo realmente importante. La modificación del estado o roles se usará (si se permite) para testear la seguridad desde el formulario de mantenimiento. Si no es necesario, la implementación de la parte de modificación (set) puede dejarse vacía. </p><p><br />Por cada formulario o control de usuario en el que queramos aplicar una política de restricciones añadiremos un componente <tt>ControlRestrictedUI</tt>. La configuración de este componente se hará normalmente en tiempo de diseño. Como ejemplo (viéndolo a través del código generado por el Designer): </p><pre class="prettyprint"><span class="str">'ControlRestrictedUIWinForms1'</span><span class="pln"><br /><br /></span><span class="typ">Me</span><span class="pun">.</span><span class="typ">ControlRestrictedUIWinForms1</span><span class="pun">.</span><span class="typ">ConfigFile</span><span class="pln"></span><span class="pun">=</span><span class="pln"></span><span class="str">"TestWinForms\Security.txt"</span><span class="pln"><br /></span><span class="typ">Me</span><span class="pun">.</span><span class="typ">ControlRestrictedUIWinForms1</span><span class="pun">.</span><span class="typ">ControlsFile</span><span class="pln"></span><span class="pun">=</span><span class="pln"></span><span class="str">"TestWinForms\Controls.txt"</span><span class="pln"><br /></span><span class="typ">Me</span><span class="pun">.</span><span class="typ">ControlRestrictedUIWinForms1</span><span class="pun">.</span><span class="pln">ID </span><span class="pun">=</span><span class="pln"></span><span class="str">"Form1"</span><span class="pln"><br /></span><span class="typ">Me</span><span class="pun">.</span><span class="typ">ControlRestrictedUIWinForms1</span><span class="pun">.</span><span class="typ">InstanceID</span><span class="pln"></span><span class="pun">=</span><span class="pln"></span><span class="str">"00"</span><span class="pln"><br /></span><span class="typ">Me</span><span class="pun">.</span><span class="typ">ControlRestrictedUIWinForms1</span><span class="pun">.</span><span class="typ">ParentControl</span><span class="pln"></span><span class="pun">=</span><span class="pln"></span><span class="typ">Me</span><span class="pln"><br /></span><span class="typ">Me</span><span class="pun">.</span><span class="typ">ControlRestrictedUIWinForms1</span><span class="pun">.</span><span class="typ">Paused</span><span class="pln"></span><span class="pun">=</span><span class="pln"></span><span class="kwd">False</span><span class="pln"><br /></span><span class="typ">Me</span><span class="pun">.</span><span class="typ">ControlRestrictedUIWinForms1</span><span class="pun">.</span><span class="typ">RestrictionsDefinition</span><span class="pln"></span><span class="pun">=</span><span class="pln"></span><span class="typ">New</span><span class="pln"></span><span class="typ">String</span><span class="pun">()</span><span class="pln"></span><span class="pun">{</span><span class="pln"><br /></span><span class="str">"$Group 0= GroupBox1.CheckBox1, GroupBox1.TextBox2"</span><span class="pun">,</span><span class="pln"><br /></span><span class="str">"$Group 2= TextBox"</span><span class="pun">,</span><span class="pln"><br /></span><span class="str">"+0/GroupBox1.CheckBox1,E,2,7"</span><span class="pun">,</span><span class="pln"></span><span class="str">"+99,33/Combo,V"</span><span class="pun">}</span></pre><blockquote>En este ejemplo se está configurando la política de seguridad de ese formulario de manera que el control <tt>CheckBox1</tt> incluido dentro de <tt>GroupBox1</tt> sólo estará habilitado cuando el estado de la aplicación sea 2 o 7, con independencia del rol del usuario. Y que el control <tt>Combo</tt> sólo lo podrán ver los roles 99 y 33. Nota: En las restricciones definidas directamente sobre el componente no se usan alias de roles, para no depender de ninguna tabla de traducción. </blockquote><p><br />Aparte de esa configuración, podemos añadir el siguiente código al inicio de ese formulario o contenedor, por ejemplo en el evento Load: </p><pre class="prettyprint"><span class="str">'Si vamos a querer que la aplicación permita determinar un estado y rol o roles'</span><span class="pln"><br /></span><span class="str">'independiente para cada instancia de una pantalla, porque podamos abrir varias'</span><span class="pln"><br /></span><span class="str">'simultáneamente y éstas pueda tener vidas independientes, entonces tendremos que'</span><span class="pln"><br /></span><span class="str">'identificar cada instancia:'</span><span class="pln"><br /></span><span class="str">'ControlRestrictedUIWinForms1.InstanceID = _InstanceID<br /><br />'</span><span class="typ">Si</span><span class="pln"> hemos creado din</span><span class="pun">á</span><span class="pln">micamente controles entonces podemos actualizar el fichero de</span><span class="str">'<br />'</span><span class="pln"> controles </span><span class="pun">(</span><span class="pln">si estamos desarrollando querremos que en modo dise</span><span class="pun">ñ</span><span class="pln">o se nos permita</span><span class="str">' <br />'</span><span class="pln">establecer la seguridad sobre controles </span><span class="kwd">no</span><span class="pln"> disponibles m</span><span class="pun">á</span><span class="pln">s que en tiempo de </span><span class="str">'ejecución):'</span><span class="pln"><br /></span><span class="com">#If DEBUG Then</span><span class="pln"><br />  </span><span class="str">' Para mantener actualizado el fichero de controles y así tener la posibilidad de considerarlos'</span><span class="pln"><br />  </span><span class="str">' al editar la seguridad en tiempo de diseño'</span><span class="pln"><br />   </span><span class="typ">ControlRestrictedUIWinForms1</span><span class="pun">.</span><span class="typ">RegisterControls</span><span class="pun">()</span><span class="pln"><br /></span><span class="com">#End If</span><span class="pln"><br /><br /></span><span class="str">'En cualquier caso, si hemos creado controles dinámicamente, no habrán sido localizados '</span><span class="pln"><br /></span><span class="str">'al inicializarse la seguridad. Por ello forzaremos a que se reconsidere la seguridad:'</span><span class="pln"><br /> </span><span class="typ">ControlRestrictedUIWinForms1</span><span class="pun">.</span><span class="typ">ReinitializeSecurity</span><span class="pun">()</span></pre><p><br />Es posible establecer la seguridad directamente a nivel de entorno, para todos o sólo una selección de componentes mediante una cadena de texto, contenida por ejemplo en un fichero, similar a la siguiente: </p><pre class="prettyprint"><span class="pun">[</span><span class="typ">Factories</span><span class="pun">]</span><span class="pln"><br /></span><span class="pun">;</span><span class="pln"></span><span class="typ">Las</span><span class="pln"> rutas relativas se expresar</span><span class="pun">á</span><span class="pln">n de manera relativa a la carpeta de la soluci</span><span class="pun">ó</span><span class="pln">n </span><span class="pun">(.</span><span class="pln">sln</span><span class="pun">).</span><span class="pln"></span><span class="typ">Esta</span><span class="pln"> ruta se utilizar</span><span class="pun">á</span><span class="pln"> para localizar las DLL en tiempo de dise</span><span class="pun">ñ</span><span class="pln">o<br /></span><span class="pun">;</span><span class="pln"></span><span class="typ">Se</span><span class="pln"> supondr</span><span class="pun">á</span><span class="pln"> que la DLL se encuentra en la misma carpeta que el ejecutable</span><span class="pun">,</span><span class="pln"> por lo que en tpo</span><span class="pun">.</span><span class="pln"> de ejecuci</span><span class="pun">ó</span><span class="pln">n se ignorar</span><span class="pun">á</span><span class="pln"> la ruta y se utilizar</span><span class="pun">á</span><span class="pln"></span><span class="pun">ú</span><span class="pln">nicamente el nombre </span><span class="kwd">del</span><span class="pln"> fichero<br /></span><span class="pun">;</span><span class="pln"></span><span class="typ">Nota</span><span class="pun">:</span><span class="pln"> es posible utilizar tambi</span><span class="pun">é</span><span class="pln">n rutas absolutas</span><span class="pun">.</span><span class="pln"><br /></span><span class="typ">TestWinForms</span><span class="pun">\</span><span class="pln">bin</span><span class="pun">\</span><span class="typ">Debug</span><span class="pun">\</span><span class="typ">RestrictedWinFormsUI_Infragistics</span><span class="pun">.</span><span class="pln">dll</span><span class="pun">,</span><span class="pln"></span><span class="typ">RestrictedWinFormsUI_Infragistics</span><span class="pun">.</span><span class="typ">AdapterInfragisticsWinForms_Factory</span><span class="pln"><br /><br /></span><span class="pun">[</span><span class="typ">CommonRoles</span><span class="pun">]</span><span class="pln"><br /></span><span class="lit">99</span><span class="pun">,</span><span class="typ">Administrator</span><span class="pun">,</span><span class="typ">Adm</span><span class="pln"><br /></span><span class="lit">10</span><span class="pun">,</span><span class="typ">Director</span><span class="pun">,</span><span class="typ">Dtor</span><span class="pln"><br /></span><span class="lit">20</span><span class="pun">,</span><span class="typ">Consultant</span><span class="pun">,</span><span class="typ">Cons</span><span class="pln"><br /><br /></span><span class="pun">[</span><span class="typ">CommonStates</span><span class="pun">]</span><span class="pln"><br /></span><span class="lit">0</span><span class="pun">,</span><span class="typ">Initial</span><span class="pln"><br /></span><span class="lit">1</span><span class="pun">,</span><span class="typ">Pending</span><span class="pln"></span><span class="typ">Validating</span><span class="pln"><br /></span><span class="lit">2</span><span class="pun">,</span><span class="typ">Validated</span><span class="pln"><br /><br /></span><span class="pun">;=======================================================</span><span class="pln"><br /></span><span class="pun">[</span><span class="pln">SECURITYCONTROL</span><span class="pun">=</span><span class="typ">Form1</span><span class="pun">]</span><span class="pln"><br /></span><span class="pun">[</span><span class="typ">Roles</span><span class="pun">]</span><span class="pln"><br /></span><span class="lit">30</span><span class="pun">,</span><span class="typ">Auxiliar</span><span class="pun">,</span><span class="typ">Aux</span><span class="pln"><br /><br /></span><span class="pun">[</span><span class="typ">States</span><span class="pun">]</span><span class="pln"><br /></span><span class="lit">3</span><span class="pun">,</span><span class="typ">Special</span><span class="pln"></span><span class="typ">State</span><span class="pln"><br /><br /></span><span class="pun">[</span><span class="typ">Groups</span><span class="pun">]</span><span class="pln"><br /></span><span class="typ">Group</span><span class="pln"></span><span class="typ">Disable</span><span class="pln"></span><span class="typ">Buttons</span><span class="pun">=</span><span class="pln"> gbCommands</span><span class="pun">.</span><span class="pln">btnDisableEnabled</span><span class="pun">,</span><span class="pln"> gbCommands</span><span class="pun">.</span><span class="pln">btnDisableVisible<br /></span><span class="typ">Group</span><span class="pln"></span><span class="typ">Enabled</span><span class="pln"></span><span class="typ">Buttons</span><span class="pun">=</span><span class="pln"> gbCommands</span><span class="pun">.</span><span class="pln">btnEnableEnabled</span><span class="pun">,</span><span class="pln"> gbCommands</span><span class="pun">.</span><span class="pln">btnEnableVisible</span><span class="pun">,</span><span class="pln"> gbCommands</span><span class="pun">.</span><span class="pln">btnEnableVisible_N<br /></span><span class="typ">Group</span><span class="pln"></span><span class="typ">Trees</span><span class="pun">=</span><span class="pln"></span><span class="typ">TreeView1</span><span class="pun">,</span><span class="pln"></span><span class="typ">UltraTree1</span><span class="pln"><br /><br /></span><span class="pun">[</span><span class="typ">Restrictions</span><span class="pun">]</span><span class="pln"><br /></span><span class="pun">+</span><span class="lit">123</span><span class="pun">/</span><span class="typ">TextBox</span><span class="pun">,</span><span class="pln">V</span><span class="pun">,</span><span class="lit">2</span><span class="pln"><br /></span><span class="pun">+</span><span class="typ">Adm</span><span class="pun">/</span><span class="pln">$Group </span><span class="typ">Trees</span><span class="pun">,</span><span class="pln">E</span><span class="pun">/</span><span class="typ">MenuStrip1</span><span class="pun">.</span><span class="typ">EditarToolStripMenuItem</span><span class="pun">.</span><span class="typ">CortarToolStripMenuItem</span><span class="pun">,</span><span class="pln">V<br /></span><span class="pun">+</span><span class="typ">Dtor</span><span class="pun">/</span><span class="typ">GroupBox1</span><span class="pun">.</span><span class="typ">CheckBox1</span><span class="pun">,</span><span class="pln">V<br /></span><span class="pun">-</span><span class="lit">0</span><span class="pun">/</span><span class="typ">MenuStrip1</span><span class="pun">.</span><span class="typ">ArchivoToolStripMenuItem</span><span class="pun">.</span><span class="typ">NuevoToolStripMenuItem</span><span class="pun">,</span><span class="pln">E</span><span class="pun">/</span><span class="typ">ToolStrip1</span><span class="pun">.</span><span class="typ">ToolStripComboBox1</span><span class="pun">,</span><span class="pln">E</span><span class="pun">/</span><span class="typ">ToolStrip1</span><span class="pun">.</span><span class="typ">ToolStripSplitButton1</span><span class="pun">,</span><span class="pln">E<br /></span><span class="pun">-</span><span class="typ">Aux</span><span class="pun">/</span><span class="pln">cControles</span><span class="pun">.</span><span class="typ">Name</span><span class="pun">,</span><span class="pln">V</span><span class="pun">,</span><span class="lit">1</span><span class="pun">,</span><span class="lit">2</span><span class="pun">,</span><span class="lit">3</span><span class="pun">/</span><span class="pln">$Group </span><span class="typ">Enabled</span><span class="pln"></span><span class="typ">Buttons</span><span class="pun">,</span><span class="pln">V<br /></span><span class="pun">-</span><span class="typ">Cons</span><span class="pun">/</span><span class="pln">combo</span><span class="pun">,</span><span class="pln">V</span><span class="pun">/</span><span class="pln">$Group </span><span class="typ">Disable</span><span class="pln"></span><span class="typ">Buttons</span><span class="pun">,</span><span class="pln">E<br /><br /></span><span class="pun">;=======================================================</span><span class="pln"><br /></span><span class="pun">[</span><span class="pln">SECURITYCONTROL</span><span class="pun">=</span><span class="typ">Form2_Sub1</span><span class="pun">]</span><span class="pln"><br /></span><span class="pun">[</span><span class="typ">Roles</span><span class="pun">]</span><span class="pln"><br /><br /></span><span class="pun">[</span><span class="typ">States</span><span class="pun">]</span><span class="pln"><br /><br /></span><span class="pun">[</span><span class="typ">Groups</span><span class="pun">]</span><span class="pln"><br /></span><span class="typ">Grupo</span><span class="pln"></span><span class="lit">0</span><span class="pun">=</span><span class="pln"></span><span class="typ">CheckBox1</span><span class="pun">,</span><span class="pln"></span><span class="typ">TextBox1</span><span class="pln"><br /></span><span class="typ">Grupo</span><span class="pln"></span><span class="lit">1</span><span class="pln"></span><span class="pun">-</span><span class="pln"> nuevo grupo</span><span class="pun">=</span><span class="pln"></span><span class="typ">Button1</span><span class="pun">,</span><span class="pln"></span><span class="typ">TextBox1</span><span class="pln"><br /><br /></span><span class="pun">[</span><span class="typ">Restrictions</span><span class="pun">]</span><span class="pln"><br /></span><span class="pun">+</span><span class="lit">0</span><span class="pun">/</span><span class="pln">$Grupo </span><span class="lit">0</span><span class="pun">,</span><span class="pln">E<br /></span><span class="pun">-</span><span class="lit">0</span><span class="pun">/</span><span class="typ">CheckBox1</span><span class="pun">,</span><span class="pln">E</span><span class="pun">/</span><span class="typ">Button1</span><span class="pun">,</span><span class="pln">E</span></pre><p><br />A través de esta funcionalidad es posible almacenar restricciones de seguridad en un repositorio centralizado, por ejemplo una BD relacional, para luego recuperarlas y aplicarlas al inicio del la aplicación. De esta manara podemos modificar las restricciones sin necesidad de recompilar las aplicaciones. </p><p>En la definición a cargar en el Entorno, por ejemplo desde un fichero, pueden utilizarse alias de roles para definir las restricciones, pues se da por hecho que éstos estarán definidos en el mismo fichero. De cualquier manera al aplicarse al componente de seguridad se traducen en los códigos correspondientes. </p><p>Hay que tener en cuenta que el uso de alias es totalmente opcional, como lo es el definir listas de estados y de roles. No son más que una ayuda para facilitar la definición de las restricciones. Lo único importante es que los códigos de los roles y de los estados los entienda la aplicacion a través del objeto que implemente la interface IHost. </p><p>Al llamar a <tt>SecurityEnvironment.LoadFrom</tt> o <tt>LoadFormString</tt>, las restricciones definidas en el fichero o cadena de texto tendrán prioridad sobre la embebida en los componentes. Si en ese texto no hay ningún apartado relativo a un determinado componente se seguirá aplicando la seguridad embebida en ese componente. Si se quisiera eliminar todas las restricciones de un componente bastaría con incluirle un apartado a ese componente dejándolo vacío: </p><pre class="prettyprint"><span class="pun">;=======================================================</span><span class="pln"><br /></span><span class="pun">[</span><span class="pln">SECURITYCONTROL</span><span class="pun">=</span><span class="typ">Form3</span><span class="pun">]</span><span class="pln"><br /><br /></span><span class="pun">;=======================================================</span><span class="pln"><br /></span><span class="pun">[</span><span class="pln">SECURITYCONTROL</span><span class="pun">=</span><span class="typ">Form4</span><span class="pun">]</span><span class="pln"><br /></span><span class="pun">[</span><span class="typ">Restrictions</span><span class="pun">]</span><span class="pln"><br /></span><span class="pun">-</span><span class="lit">0</span><span class="pun">/</span><span class="typ">CheckBox1</span><span class="pun">,</span><span class="pln">E</span><span class="pun">/</span><span class="typ">Button1</span><span class="pun">,</span><span class="pln">E</span></pre><p><br /></p><p><br /><br /></p><h3><a name="Mantenimiento_de_la_política_de_seguridad:_FrmRestrictionsUIDef">Mantenimiento de la política de seguridad: <tt>FrmRestrictionsUIDefinition</tt></a></h3><p><a name="Mantenimiento_de_la_política_de_seguridad:_FrmRestrictionsUIDef">Tanto la configuración embebida directamente en el componente como a través de archivos de configuración similares al indicado, son generables mediante el formulario de mantenimiento incorporado, y fácilmente modificables a mano si es necesario. Este formulario de mantenimiento está accesible tanto en tiempo de diseño como de ejecución. En tiempo de diseño se puede acceder a él pulsando en el botón ... correspondiente a la propiedad <tt>RestrictionsDefinition</tt> de un componente <tt>ControlRestrictedUI</tt>; en tiempo de ejecución mediante el método <tt>ShowConfigurationSecurityForm</tt> y también directamente pulsando una combinación de teclas habilitada para ello mediante <tt>SecurityEnvironment.AllowedHotKey</tt> (por defecto desactivado) </a></p><p><a name="Mantenimiento_de_la_política_de_seguridad:_FrmRestrictionsUIDef"><img src="file:///D:/PROYECTOS/Restricted-ui/DocProject/Help/Art/frmRestrictionsUIDefinition.gif" /></a></p><p><a name="Mantenimiento_de_la_política_de_seguridad:_FrmRestrictionsUIDef">Básicamente lo que podemos hacer es seleccionar (checkbox) uno o varios controles, la propiedad o propiedades que queremos controlar (Visible, Enabled) y opcionalmente uno o varios roles así como uno o varios estados. Al pulsar en el botón Permitir añadiremos una nueva restricción (positiva) relacionada con esa selección. Al pulsar en Impedir añadiremos una restricción negativa. Podemos definir grupos de controles, con un nombre asociado, y establecer restricciones directamente al grupo. Para añadir o actualizar un grupo existente marcaremos una serie de controles y pulsaremos Añadir. Nos preguntará por un nombre para el grupo. Si ya existe lo reemplazará por la nueva selección, en caso contrario lo añadirá. Al seleccionar uno u otro grupo se irán seleccionando en la tabla de controles los elementos correspondientes al grupo. Cuando esté marcada la casilla 'Mostrar sólo Grupo seleccionado' entonces al pulsar en Permitir o Impedir, la restricción se asociará directamente al grupo correspondiente. </a></p><p><a name="Mantenimiento_de_la_política_de_seguridad:_FrmRestrictionsUIDef">Tenemos la opción de salvar las restricciones establecidas en un archivo de configuración, añadiéndose a las restricciones que puedan ya existir relativas a otros componentes. Este archivo será inicialmente el que se haya establecido (si alguno) para el componente. Podemos leer la configuración de seguridad del componente desde el que hemos lanzado este formulario, o todos los que pueda haber incluidos en el archivo. </a></p><p><a name="Mantenimiento_de_la_política_de_seguridad:_FrmRestrictionsUIDef">Contamos para mayor facilidad con dos formas de mostrar los permisos: tabular o de texto, ambas editables. <img src="file:///D:/PROYECTOS/Restricted-ui/DocProject/Help/Art/frmRestrictionsUIDefinition_text.gif" /></a></p><p><a name="Mantenimiento_de_la_política_de_seguridad:_FrmRestrictionsUIDef">Si usamos este formulario en tiempo de ejecución podremos también hacer doble click en un control para hacerlo resaltar (parpadeará varias veces) Tendremos también la posibilidad de modificar (si el objeto que implemente la interface <tt>IHost</tt> lo permite) el estado y el rol o roles asociados a este componente e instancia, para así testear la seguridad. Para mayor comodidad podemos reducir este formulario para que sólo ofrezca estos controles: </a></p><p><a name="Mantenimiento_de_la_política_de_seguridad:_FrmRestrictionsUIDef"><img src="file:///D:/PROYECTOS/Restricted-ui/DocProject/Help/Art/frmRestrictionsUIDefinition_reduced.gif" /></a></p><p><a name="Mantenimiento_de_la_política_de_seguridad:_FrmRestrictionsUIDef"><br /><br /></a></p><h2><a name="2.3._Proyectos_de_test">2.3. Proyectos de test</a></h2><p><a name="2.3._Proyectos_de_test">Junto a la solución se incluyen tres proyectos, dos sobre WinForms y sobre Web: TestWeb, TestWinForms y TestWinForms_notUsingInfragistics. Los dos proyectos en WinForms son equivalentes con la única diferencia de que el último no hace uso de ningún control (</a><a href="http://www.infragistics.com/dotnet/netadvantage.aspx" rel="nofollow">NetAdventage</a>) de Infragistics, librería de controles utilizada en mi empresa y que he incluido para demostrar el uso de factorías adicionales para tratar controles especiales. </p><p>Los ejemplos en WinForms incluyen un formulario (Form1) con el cual es posible jugar con todas las características de esta librería, incluyendo la posibilidad de pausar la seguridad, forzar la visibilidad o el enabled de un control, o aplicar una lógica más elaborada con la ayuda del evento <tt>BeforeApplyingRestriction</tt>. El formulario Form1 en TestWinForms es el siguiente: </p><p><img src="file:///D:/PROYECTOS/Restricted-ui/DocProject/Help/Art/TestForm1.gif" /></p><p><br /><br />El formulario Form2 permite mostrar el tratamiento de la seguridad sobre controles de usuario: las pestañas 1 y 2 tienen incrustado un control de usuario sobre el que se ha aplicado una serie de restricciones que hacen que sólo sea editable el cuadro de texto. Las pestañas 3 y 4 incluyen otro control de usuario cuya política de seguridad oculta un nodo del TreeView. Aparte de esa restricción específica de este segundo control de usuario, el componente de seguridad de este formulario Form2 aplica una restricción sobre la instancia del control de usuario de la pestaña 4 de manera que el segundo radiobutton esté deshabilitado. </p><p><img src="file:///D:/PROYECTOS/Restricted-ui/DocProject/Help/Art/TestForm2.gif" /></p><p>Tanto en Form1 como en Form2 está habilitada como tecla que muestra el formulario de mantenimiento de la seguridad en tiempo de ejecución la combinación de teclas CTR-ALT-End </p><p><br /><br /></p><h1><a name="3._Points_of_Interest">3. Points of Interest</a></h1><ul><li><a name="3._Points_of_Interest">Del desarrollo de este código me ha resultado muy interesante descubrir las posibilidades que ofrece este tipo de "inyección" de código, que permite controlar o influir en la aplicación Host sin necesidad de hacer cambios en la misma (salvo naturalmente la configuración normal de la librería). Este enfoque se ha empleado para actuar (impidiendo según una política de seguridad) sobre un par de propiedades habituales de los controles, Visible y Enabled, pero podría utilizarse para muchos otros usos. </a></li></ul><ul><li><a name="3._Points_of_Interest">El patrón Indirección, a través de la interface <tt>IControlAdapter</tt>, ha sido fundamental para conseguir este objetivo, y algo muy potente. Su uso con el patrón Factory ha sido también muy conveniente. </a></li></ul><blockquote><a name="3._Points_of_Interest">El uso de estos dos patrones han hecho posible la extensibilidad de esta arquitectura, permitiendo incorporar nuevas librerías que ofrezcan un tratamiento personalizado de determinados controles. </a></blockquote><ul><li><a name="3._Points_of_Interest">Aunque sea algo aparentemente menor me parece interesante señalar el uso del patrón Caso Especial, tal y como describe Martin Fowler en </a><a href="http://martinfowler.com/eaaCatalog/specialCase.html" rel="nofollow">P of EAA: Special Case</a> y las ventajas claras que repercute en el código. Este patrón está siendo utilizado mediante el objeto <tt>NullControlAdapter</tt>. </li></ul><ul><li>Durante el desarrollo del componente <tt>ControlRestrictedUI</tt> tuve dificultades con el hecho de que las propiedades establecidas en tiempo de diseño fueran inicializadas por el Designer en un orden alfabético. La inicialización de la seguridad en un componente se realiza al establecer la propiedad <tt>RestrictionsDefinition</tt>, pero en ese momento, en la inicialización del mismo por parte del Designer otras propiedades necesarias no estaban establecidas. La solución a este problema la ofrece la interface <tt>ISupportInitialize</tt> (<a href="http://en.csharp-online.net/Design-Time_Integration%E2%80%94Batch_Initialization" rel="nofollow">Design-Time Integration—Batch Initialization</a>) </li></ul><ul><li>También ha resultado muy cómodo y limpio el uso de la interface <tt>INotifyPropertyChanged</tt> para asegurar el correcto enlace de datos bidireccional (databindings) entre controles de usuario y entidades de negocio (<a href="http://www.claassen.net/geek/blog/2007/07/generic-asynchronous.html" rel="nofollow">A generic asynchronous INotifyPropertyChanged helper</a>)) </li></ul><ul><li>Una dificultad importante de este desarrollo ha estado relacionada con el trabajo del componente en tiempo de diseño. Especialmente problemática resultó la instanciación dinámica de objetos <tt>IControlAdapterFactory</tt> en tiempo de diseño, lo que provocaba excepciones InvalidCastException. </li></ul><blockquote>Entre otros, el siguiente artículo me ayudó a comprender el problema y el por qué de las excepciones InvalidCastException que estaba obteniendo al instanciar dinámicamente los objetos que implementaban la interface <tt>IControlAdapterFactory</tt>: <a href="http://www.yoda.arachsys.com/csharp/plugin.html" rel="nofollow">Plug-ins and cast exceptions</a> Pude comprobar posteriormente que al estar instanciando la librería para cargar la factoría auxiliar mediante <tt>Assembly.LoadFrom</tt> en tiempo de diseño, las estaba cargando en el dominio de aplicación por defecto del proceso asociado al IDE, con lo que estas DLL no era liberadas más que al cerrar el IDE, llegando por tanto a tener por tanto múltiples definiciones aparentemente iguales en memoria. El problema lo resolví cargando la DLL dentro un dominio independiente, aislado, de aplicación, utilizando <tt>AppDomain.LoadFrom</tt> en lugar de <tt>Assembly.LoadFrom</tt>, y descargando el dominio una vez utilizada la factoría. </blockquote><ul><li>Para documentar las clases y métodos me he apoyado en los comentarios al código y he utilizado <a href="http://docproject.codeplex.com/" rel="nofollow">DocProject</a>, herramienta construida sobre <a href="http://sandcastle.codeplex.com/" rel="nofollow">Sandcastle - Documentation Compiler for Managed Class Libraries</a>. Es una combinación extremedamente cómoda y potente. En concreto me he basado en la versión 1.11.0 Release Candidate de DocProject y de Sandcastle May 2008 Release. </li></ul><p /></p></summary>
    </member>
  </members>
</doc>